<html lang="{{lang}}">
<head>
  <title>{{activity}} - {{name}}</title>
  <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" type="image/png" href="/assets/icon/favicon.png" />
<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  font-family: "Roboto", "Helvetica Neue", sans-serif;
  font-size: 16px;
}
body {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  --width: calc(min(100vw, 800px));
  --map-size: calc(var(--width) / 2);

  --ion-color-primary: #00a000;
	--ion-color-primary-rgb: 0,160,0;
	--ion-color-primary-contrast: #ffffff;
	--ion-color-primary-contrast-rgb: 255,255,255;

	--ion-color-secondary: #B88858;
	--ion-color-secondary-rgb: 184,136,88;
	--ion-color-secondary-contrast: #FFFFFF;
	--ion-color-secondary-contrast-rgb: 255, 255, 255;

	--ion-color-tertiary: #48A0F0;
	--ion-color-tertiary-rgb: 72,160,240;
	--ion-color-tertiary-contrast: #000000;
	--ion-color-tertiary-contrast-rgb: 0,0,0;

  --ion-background-color: #ffffff;
	--ion-background-color-rgb: 255,255,255;

	--ion-text-color: #000000;
	--ion-text-color-rgb: 0,0,0;

  --centered-outside-background: rgba(0, 0, 0, 0.1);
  --centered-inside-background: #FFFFFF;

  --star-color: #d29711;

  background-color: var(--ion-background-color);
  color: var(--ion-text-color);
}

@media (prefers-color-scheme: dark) {
  body {
    --ion-color-primary: #005000;
    --ion-color-primary-rgb: 0,80,0;
    --ion-color-primary-contrast: #ffffff;
    --ion-color-primary-contrast-rgb: 255,255,255;

    --ion-color-secondary: #C89868;
    --ion-color-secondary-rgb: 200,152,104;
    --ion-color-secondary-contrast: #000000;
    --ion-color-secondary-contrast-rgb: 0,0,0;

    --ion-color-tertiary: #30C0D8;
    --ion-color-tertiary-rgb: 48,192,216;
    --ion-color-tertiary-contrast: #000000;
    --ion-color-tertiary-contrast-rgb: 0,0,0;

    --ion-background-color: #121212;
    --ion-background-color-rgb: 18, 18, 18;
    --ion-text-color: #ffffff;
    --ion-text-color-rgb: 255, 255, 255;
    --centered-outside-background: var(--ion-background-color);
    --centered-inside-background: rgba(var(--ion-text-color-rgb), 0.1);

    --star-color: yellow;
  }
}
svg.ionicon {
  stroke: currentColor;
  fill: currentColor;

  .ionicon-fill-none {
    fill: none;
  }

  .ionicon-stroke-width {
    stroke-width: var(--ionicon-stroke-width, 32px);
  }
}

div.content-container {
  flex: 1 1 100%;
  background-color: var(--centered-outside-background);
}
div.header {
  max-width: var(--width);
  margin: auto;
  background-color: var(--ion-color-primary);
  color: var(--ion-color-primary-contrast);
  display: flex;
  flex-direction: row;
  align-items: center;
  padding: 8px 12px;
}
div.header div.icon {
  width: 32px;
  height: 32px;
  margin-right: 12px;
}
div.header div.icon svg {
  width: 32px;
  height: 32px;
}
div.header span {
  font-size: 24px;
}
div.content {
  flex-direction: column;
  height: 100%;
  overflow-y: auto;
  overflow-x: hidden;
  max-width: var(--width);
  margin: auto;
  background-color: var(--centered-inside-background);
  padding: 10px;
}
h1 {
  font-size: 32px;
  margin-top: 0;
}
div.photos-and-description {
  display: flex;
  flex-direction: row;
  align-items: flex-start;
}
div.photos-and-description div.photos {
  border: 2px solid rgba(var(--ion-color-secondary-rgb), 0.75);
  border-radius: 8px;
  padding: 3px;
  margin-right: 10px;
}
div.photos-and-description div.trail-description {
  padding-top: 5px;
}
div.photos-and-description div.photos img {
  max-width: calc(min(45vw, 300px));
  max-height: 300px;
  border-radius: 6px;
}
@media (max-width: 600px) {
  h1 {
    font-size: 24px;
  }
  div.photos-and-description {
    flex-direction: column;
  }
  div.photos-and-description div.photos img {
    max-width: 90vw;
  }
}
div.map-and-metas {
  margin-top: 15px;
  display: flex;
  flex-direction: row;
}
div.map-and-metas div.map-container {
  flex: none;
}
div.map-and-metas div.metas {
  flex: 1 1 100%;
  padding-right: 8px;
}
div.meta {
  display: flex;
  flex-direction: row;
  padding: 3px 0;
}
div.meta div.icon {
  width: 32px;
  height: 32px;
  margin-right: 5px;
  color: var(--ion-color-secondary);
}
div.meta div.icon svg {
  width: 32px;
  height: 32px;
}
div.meta div.name {
  font-weight: bold;
  margin-right: 5px;
  font-size: 12px;
  color: var(--ion-color-secondary);
}
div.meta div.value {
  font-size: 14px;
}
@media (min-width: 650px) {
  div.meta-container {
    display: inline-block;
    min-width: 49%;
    max-width: 49%;
  }
}
div.rating {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  color: var(--ion-color-secondary);
  margin-top: 8px;
  font-size: 14px;
}
div.rating div.icon {
  color: var(--star-color);
  width: 12px;
  height: 12px;
}
div.rating div.icon svg {
  width: 12px;
  height: 12px;
  fill: currentColor;
}
div.stars {
  display: flex;
  flex-direction: row;
  align-items: center;
  margin: 0 8px;
}
div.map-container {
  position: relative;
  width: var(--map-size);
  height: var(--map-size);
  overflow: hidden;
  border: 1px solid rgba(var(--ion-text-color-rgb), 0.5);
  border-radius: 5px;
}
div#map-tile-layer, div#map-path-layer {
  position: absolute;
  top: 2px;
  left: 2px;
  right: 2px;
  bottom: 2px;
  overflow: hidden;
  border-radius: 4px;
}
div.map-copyright {
  position: absolute;
  bottom: 2px;
  right: 2px;
  font-size: 0.75rem;
  color: black;
  background-color: rgba(255, 255, 255, 0.33);
  padding: 1px 2px;
}
div.open-app-button {
  display: flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  margin-top: 15px;
}
div.open-app-button a, div.open-app-button a:active {
  background-color: var(--ion-color-primary);
  color: var(--ion-color-primary-contrast);
  padding: 8px 15px;
  border-radius: 5px;
  text-decoration: none;
  font-size: 18px;
}
</style>
<script type="application/jd+json">{{json:jdJson}}{{/json}}</script>
</head>
<body>
  <div class="content-container">
    <div class="header">
      <div class="icon" data="logo"></div>
      <span>Trailence</span>
    </div>
    <div class="content">
      <div class="trail-title">
        <h1>{{activity}} - {{name}}</h1>
      </div>
      {{if:photos.0}}
        <div class="photos-and-description">
          <div class="photos">
            <img src="/api/public/trails/v1/photo/{{uuid}}/{{photos.0.uuid}}"/>
          </div>
          <div class="trail-description">{{description}}</div>
        </div>
      {{/if}}
      {{if:!photos.0}}
        <div class="trail-description">{{text:description}}{{/text}}</div>
      {{/if}}
      <div class="map-and-metas">
        <div class="metas">
          {{if:location}}
          <div class="meta-container">
            <div class="meta">
              <div class="icon" data="location"></div>
              <div class="meta-content">
                <div class="name">{{i18n.metadata.trail_location}}</div>
                <div class="value">{{location}}</div>
              </div>
            </div>
          </div>
          {{/if}}
          {{if:loopType}}
          <div class="meta-container">
            <div class="meta">
              <div class="icon" data="lt:{{loopType}}"></div>
              <div class="meta-content">
                <div class="name">{{i18n.metadata.loop_type}}</div>
                <div class="value">{{i18n.loopType.|loopType|}}</div>
              </div>
            </div>
          </div>
          {{/if}}
          {{if:distance}}
          <div class="meta-container">
            <div class="meta">
              <div class="icon" data="distance"></div>
              <div class="meta-content">
                <div class="name">{{i18n.metadata.distance}}</div>
                <div class="value">{{distance:distance}}{{/distance}}</div>
              </div>
            </div>
          </div>
          {{/if}}
          {{if:estimatedDuration}}
          <div class="meta-container">
            <div class="meta">
              <div class="icon" data="duration"></div>
              <div class="meta-content">
                <div class="name">{{i18n.metadata.duration}}</div>
                <div class="value">≈ {{duration:estimatedDuration}}{{/duration}}</div>
              </div>
            </div>
          </div>
          {{/if}}
          {{if:positiveElevation}}
          <div class="meta-container">
            <div class="meta">
              <div class="icon" data="positive-elevation"></div>
              <div class="meta-content">
                <div class="name">{{i18n.metadata.positiveElevation}}</div>
                <div class="value">{{elevation:positiveElevation}}{{/elevation}}</div>
              </div>
            </div>
          </div>
          <div class="meta-container">
            <div class="meta">
              <div class="icon" data="negative-elevation"></div>
              <div class="meta-content">
                <div class="name">{{i18n.metadata.negativeElevation}}</div>
                <div class="value">{{elevation:negativeElevation}}{{/elevation}}</div>
              </div>
            </div>
          </div>
          {{/if}}
          {{if:nbRates}}
          <div class="rating">
            <span>{{i18n.pages.trail.sections.comments.rate.global}}</span>
            <div class="stars">
              <div class="icon" data="star-{{star1}}"></div>
              <div class="icon" data="star-{{star2}}"></div>
              <div class="icon" data="star-{{star3}}"></div>
              <div class="icon" data="star-{{star4}}"></div>
              <div class="icon" data="star-{{star5}}"></div>
            </div>
            <span>{{rate}}</span>
          </div>
          {{/if}}
          <div class="open-app-button">
              <a href="/trail/trailence/{{slug}}">{{i18n.pages.trail.open_in_app}} Trailence</a>
          </div>
        </div>
        <div class="map-container">
          <div id="map-tile-layer"></div>
          <div id="map-path-layer"></div>
          <div class="map-copyright">© <a href="http://www.openstreetmap.org/copyright" target="_blank">OpenStreetMap</a></div>
        </div>
      </div>
    </div>
  </div>

<script type="text/javascript">
var geo = {
  bounds: [{{boundsNorth}},{{boundsWest}},{{boundsSouth}},{{boundsEast}}],
  path: {{json:simplifiedPath}}{{/json}}
};
</script>
<script type="text/javascript">
function lon2pt(lon,zoom) { return (lon+180)/360*Math.pow(2,zoom); }
function lat2pt(lat,zoom)  { return (1-Math.log(Math.tan(lat*Math.PI/180) + 1/Math.cos(lat*Math.PI/180))/Math.PI)/2 *Math.pow(2,zoom); }

function convertBounds(north, west, south, east, zoom) {
  const x1 = lon2pt(west, zoom);
  const x2 = lon2pt(east, zoom);
  const y1 = lat2pt(north, zoom);
  const y2 = lat2pt(south, zoom);
  return {
    x1: x1 < x2 ? x1 : x2,
    y1: y1 < y2 ? y1 : y2,
    x2: x1 < x2 ? x2 : x1,
    y2: y1 < y2 ? y2 : y1
  };
}

const tileSize = 256;
const tileContainer = document.getElementById('map-tile-layer');
const mapSize = tileContainer.clientWidth;
const margin = 0.1;

let zoom = 5;
let bounds = convertBounds(geo.bounds[0], geo.bounds[1], geo.bounds[2], geo.bounds[3], zoom);
const maxPathSize = mapSize - (mapSize * margin * 2);
while (zoom < 17 && (bounds.x2 - bounds.x1) * tileSize < maxPathSize && (bounds.y2 - bounds.y1) * tileSize < maxPathSize) {
  zoom++;
  const newBounds = convertBounds(geo.bounds[0], geo.bounds[1], geo.bounds[2], geo.bounds[3], zoom);
  if ((newBounds.x2 - newBounds.x1) * tileSize > maxPathSize || (newBounds.y2 - newBounds.y1) * tileSize > maxPathSize) {
    zoom--;
    break;
  }
  bounds = newBounds;
}


const pathYMiddle = (bounds.y1 + (bounds.y2 - bounds.y1) / 2) * tileSize;
const mapTop = pathYMiddle - mapSize/2;
const topTile = Math.floor(mapTop / tileSize);
const topDiff = (topTile * tileSize) - mapTop;

const pathXMiddle = (bounds.x1 + (bounds.x2 - bounds.x1) / 2) * tileSize;
const mapLeft = pathXMiddle - mapSize/2;
const leftTile = Math.floor(mapLeft / tileSize);
const leftDiff = (leftTile * tileSize) - mapLeft;

const mapBottom = pathYMiddle + mapSize/2;
const bottomTile = Math.floor(mapBottom / tileSize);

const mapRight = pathXMiddle + mapSize/2;
const rightTile = Math.floor(mapRight / tileSize);

for (let y = topTile; y <= bottomTile; y++) {
  for (let x = leftTile; x <= rightTile; x++) {
    const img = document.createElement('IMG');
    img.width = '' + tileSize;
    img.height = '' + tileSize;
    img.src = 'https://tile.openstreetmap.org/' + zoom + '/' + x + '/' + y + '.png';
    img.style.top = (tileSize * (y - topTile) + topDiff) + 'px';
    img.style.left = (tileSize * (x - leftTile) + leftDiff) + 'px';
    img.style.position = 'absolute';
    tileContainer.appendChild(img);
  }
}

function pathPtX(index) {
  return (lon2pt(geo.path[index * 2 + 1], zoom) * tileSize) - mapLeft;
}
function pathPtY(index) {
  return (lat2pt(geo.path[index * 2], zoom) * tileSize) - mapTop;
}

let svgPath = 'M' + pathPtX(0) + ' ' + pathPtY(0);
for (let i = 1; i < geo.path.length / 2; i++) {
  svgPath += ' L' + pathPtX(i) + ' ' + pathPtY(i);
}
const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
svg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
svg.setAttribute('viewBox', '0 0 ' + mapSize + ' ' + mapSize);
svg.innerHTML = '<path d="' + svgPath + '" stroke="red" stroke-width="3" fill="none"/>';
document.getElementById('map-path-layer').appendChild(svg);

function createAnchor(borderColor, text, textColor, fillColor, fillColor2) {
  let svg = '';
  if (fillColor) {
    fillColor2 ??= fillColor;
    svg += '<path d="m957,1579.09c0,-3.33 6.67,-1516.67 5,-1516.67c-1.67,0 -571.67,40 -570,590c1.67,550 258.33,456.67 276.67,490c18.33,33.33 288.33,436.67 288.33,436.67z"';
    svg += ' fill="' + fillColor + '" stroke="' + fillColor + '"/>';
    svg += '<path d="m958,1572.42c0,0 3.33,-1510 1.67,-1510c-1.67,0 578.33,76.67 550,586.67c-28.33,510 -271.67,550 -273.33,550c-1.67,0 -278.33,373.33 -278.33,373.33z"';
    svg += ' fill="' + fillColor2 + '" stroke="' + fillColor2 + '"/>';
  }
  svg += '<path d="M1290 1083.396c-114.12 113.16-253.68 269.88-332.04 466.8-76.92-199.08-215.16-354.84-327.96-466.92-141.36-140.04-210-279.48-210-426.48 0-295.92 240.84-536.76 543.12-536.76 296.04 0 536.88 240.84 536.88 536.76 0 147-68.64 286.44-210 426.6M956.88.036C594.72.036 300 294.636 300 656.796c0 180.6 80.28 348 245.4 511.68 239.76 237.84 351.48 457.56 351.48 691.56v60h120v-60c0-232.92 110.4-446.16 357.72-691.44 165.12-163.8 245.4-331.2 245.4-511.8C1620 294.636 1325.28.036 956.88.036" fill-rule="evenodd"';
  svg += ' fill="' + borderColor + '" class="anchor-border"'
  svg += '/>';
  textColor ??= borderColor;
  svg += '<text x="960" y="700" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="600px" font-weight="bold" fill="' + textColor + '" stroke="' + textColor + '">' +text + '</text>';
  const element = document.createElementNS("http://www.w3.org/2000/svg", "svg");
  element.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
  element.setAttribute('viewBox', '0 0 1920 1920');
  element.innerHTML = svg;
  return element;
}

const departure = {x: pathPtX(0), y: pathPtY(0)};
const arrival = {x: pathPtX(geo.path.length / 2 - 1), y: pathPtY(geo.path.length / 2 - 1)};

const departureArrivalDistance = Math.sqrt((departure.x - arrival.x) * (departure.x - arrival.x) + (departure.y - arrival.y) * (departure.y - arrival.y));
if (departureArrivalDistance < 15) {
  const anchor = createAnchor('rgba(64, 128, 0, 0.75)', 'D/A', '#ffffff', 'rgba(0, 128, 0, 0.75)', 'rgba(196, 0, 0, 0.75)');
  anchor.style.position = 'absolute';
  anchor.style.width = '40px';
  anchor.style.height = '40px';
  anchor.style.top = (departure.y - 40) + 'px';
  anchor.style.left = (departure.x - 20) + 'px';
  document.getElementById('map-path-layer').appendChild(anchor);
} else {
  const dep = createAnchor('rgba(0, 128, 0, 0.75)', 'D', '#ffffff', 'rgba(0, 128, 0, 0.75)', undefined);
  const arr = createAnchor('rgba(196, 0, 0, 0.75)', 'A', '#ffffff', 'rgba(196, 0, 0, 0.75)', undefined);
  dep.style.position = 'absolute';
  dep.style.width = '40px';
  dep.style.height = '40px';
  dep.style.top = (departure.y - 40) + 'px';
  dep.style.left = (departure.x - 20) + 'px';
  document.getElementById('map-path-layer').appendChild(dep);
  arr.style.position = 'absolute';
  arr.style.width = '40px';
  arr.style.height = '40px';
  arr.style.top = (arrival.y - 40) + 'px';
  arr.style.left = (arrival.x - 20) + 'px';
  document.getElementById('map-path-layer').appendChild(arr);
}

</script>

<script type="text/javascript">
function getIconNameForLooptType(lt) {
  switch (lt) {
    case 'ow': return 'one-way';
    case 'lp': return 'loop';
    case 'hl': return 'half-loop';
    case 'sl': return 'small-loop';
    case 'ob': return 'out-and-back';
  }
  return '';
}
const ICONS_VERSION = '2';
window.fetch('/assets/icons.' + ICONS_VERSION + '.svg')
.then(response => response.text())
.then(text => {
  const el = document.createElement('html');
  el.innerHTML = text;
  const parentEl = el.getElementsByTagName('icons').item(0);
  const iconsByName = new Map();
  for (let i = 0; i < parentEl.children.length; ++i) {
    const iconChild = parentEl.children.item(i);
    if (iconChild.tagName.toLowerCase() !== 'icon') continue;
    const names = iconChild.getAttribute('names').split(',');
    const svg = iconChild.children.item(0);
    for (const name of names) iconsByName.set(name, svg);
  }

  const icons = document.getElementsByClassName('icon');
  for (let i = 0; i < icons.length; ++i) {
    const iconDiv = icons.item(i);
    let iconName = iconDiv.getAttribute('data');
    if (iconName.startsWith('lt:')) iconName = getIconNameForLooptType(iconName.substring(3));
    const icon = iconsByName.get(iconName);
    if (icon)
      iconDiv.appendChild(icon.cloneNode(true));
  }

});
</script>
</body>
</html>
